#!/bin/bash

# Claude Code Workflow ç®¡ç†è„šæœ¬
# æ”¯æŒå®‰è£…ã€æ›´æ–°ã€å¸è½½ Claude Code å·¥ä½œæµç¨‹é…ç½®

set -e  # é‡åˆ°é”™è¯¯æ—¶é€€å‡º

VERSION="1.0.0"
REPO_URL="https://raw.githubusercontent.com/layue13/MyClaudeCodeWorkflow/main"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ‰“å°å¸¦é¢œè‰²çš„æ¶ˆæ¯
print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# æ£€æŸ¥æ˜¯å¦åœ¨ç›®æ ‡é¡¹ç›®ç›®å½•ä¸­
check_target_directory() {
    if [ ! -d ".git" ]; then
        print_error "å½“å‰ç›®å½•ä¸æ˜¯ Git ä»“åº“ï¼Œè¯·åœ¨ç›®æ ‡é¡¹ç›®æ ¹ç›®å½•ä¸‹è¿è¡Œæ­¤è„šæœ¬"
        exit 1
    fi
    
    print_info "åœ¨ Git ä»“åº“ä¸­æ£€æµ‹åˆ°ï¼š$(pwd)"
}

# ä¸‹è½½é…ç½®æ–‡ä»¶
download_config() {
    print_info "æ­£åœ¨ä¸‹è½½ Claude Code é…ç½®æ–‡ä»¶..."
    
    # åˆ›å»º .claude ç›®å½•
    mkdir -p .claude/agents
    
    # ä¸‹è½½ä¸»é…ç½®æ–‡ä»¶
    print_info "ä¸‹è½½ CLAUDE.md..."
    curl -s -o CLAUDE.md "$REPO_URL/CLAUDE.md" || {
        print_error "ä¸‹è½½ CLAUDE.md å¤±è´¥"
        exit 1
    }
    
    # ä¸‹è½½ä»£ç†é…ç½®æ–‡ä»¶
    print_info "ä¸‹è½½ä»£ç†é…ç½®æ–‡ä»¶..."
    curl -s -o .claude/agents/research-agent.md "$REPO_URL/.claude/agents/research-agent.md" || {
        print_error "ä¸‹è½½ research-agent.md å¤±è´¥"
        exit 1
    }
    
    curl -s -o .claude/agents/solution-agent.md "$REPO_URL/.claude/agents/solution-agent.md" || {
        print_error "ä¸‹è½½ solution-agent.md å¤±è´¥"
        exit 1
    }
    
    curl -s -o .claude/agents/github-agent.md "$REPO_URL/.claude/agents/github-agent.md" || {
        print_error "ä¸‹è½½ github-agent.md å¤±è´¥"
        exit 1
    }
    
    print_success "é…ç½®æ–‡ä»¶ä¸‹è½½å®Œæˆ"
}

# æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
check_installed() {
    if [ -f "CLAUDE.md" ] && [ -d ".claude/agents" ]; then
        return 0  # å·²å®‰è£…
    else
        return 1  # æœªå®‰è£…
    fi
}

# å¤‡ä»½ç°æœ‰é…ç½®
backup_config() {
    if check_installed; then
        local backup_dir=".claude_backup_$(date +%Y%m%d_%H%M%S)"
        print_info "å¤‡ä»½ç°æœ‰é…ç½®åˆ° $backup_dir..."
        
        mkdir -p "$backup_dir"
        [ -f "CLAUDE.md" ] && cp "CLAUDE.md" "$backup_dir/"
        [ -d ".claude" ] && cp -r ".claude" "$backup_dir/"
        
        print_success "é…ç½®å·²å¤‡ä»½"
        echo "$backup_dir" > .claude_last_backup
    fi
}

# å¸è½½é…ç½®
uninstall_config() {
    print_info "å¼€å§‹å¸è½½ Claude Code Workflow..."
    
    if ! check_installed; then
        print_warning "Claude Code Workflow æœªå®‰è£…ï¼Œæ— éœ€å¸è½½"
        return
    fi
    
    # è¯¢é—®æ˜¯å¦ç¡®è®¤å¸è½½
    echo -n "ç¡®å®šè¦å¸è½½ Claude Code Workflow å—? (y/N): "
    read -r confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        print_info "å–æ¶ˆå¸è½½"
        return
    fi
    
    # å¤‡ä»½é…ç½®
    backup_config
    
    # åˆ é™¤é…ç½®æ–‡ä»¶
    print_info "åˆ é™¤é…ç½®æ–‡ä»¶..."
    rm -f CLAUDE.md
    rm -rf .claude/agents
    
    # å¦‚æœ .claude ç›®å½•ä¸ºç©ºåˆ™åˆ é™¤
    if [ -d ".claude" ] && [ -z "$(ls -A .claude)" ]; then
        rmdir .claude
    fi
    
    # æ¸…ç† .gitignore ä¸­çš„è§„åˆ™
    if [ -f ".gitignore" ]; then
        print_info "æ¸…ç† .gitignore..."
        # åˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼Œæ’é™¤Claude Codeç›¸å…³è§„åˆ™
        grep -v "settings.local.json\|*.local.json\|.claude/settings.local.json\|# Claude Code local settings" .gitignore > .gitignore.tmp 2>/dev/null || true
        mv .gitignore.tmp .gitignore
    fi
    
    print_success "å¸è½½å®Œæˆï¼"
    
    if [ -f ".claude_last_backup" ]; then
        local backup_dir=$(cat .claude_last_backup)
        print_info "å¦‚éœ€æ¢å¤ï¼Œå¤‡ä»½æ–‡ä»¶åœ¨ï¼š$backup_dir"
        rm .claude_last_backup
    fi
}

# æ›´æ–°é…ç½®
update_config() {
    print_info "å¼€å§‹æ›´æ–° Claude Code Workflow..."
    
    if ! check_installed; then
        print_warning "Claude Code Workflow æœªå®‰è£…ï¼Œè¯·å…ˆä½¿ç”¨ install å‘½ä»¤å®‰è£…"
        return
    fi
    
    # å¤‡ä»½ç°æœ‰é…ç½®
    backup_config
    
    # ä¸‹è½½æœ€æ–°é…ç½®
    download_config
    update_gitignore
    
    print_success "æ›´æ–°å®Œæˆï¼"
    
    if [ -f ".claude_last_backup" ]; then
        local backup_dir=$(cat .claude_last_backup)
        print_info "åŸé…ç½®å·²å¤‡ä»½åˆ°ï¼š$backup_dir"
        rm .claude_last_backup
    fi
}

# å®‰è£…é…ç½®
install_config() {
    print_info "å¼€å§‹å®‰è£… Claude Code Workflow..."
    
    if check_installed; then
        print_warning "Claude Code Workflow å·²å®‰è£…ï¼Œè¯·ä½¿ç”¨ update å‘½ä»¤æ›´æ–°"
        return
    fi
    
    download_config
    update_gitignore
    show_next_steps
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo "================================================="
    echo "    Claude Code Workflow çŠ¶æ€"
    echo "================================================="
    echo
    
    if check_installed; then
        print_success "Claude Code Workflow å·²å®‰è£…"
        echo
        print_info "å·²å®‰è£…çš„æ–‡ä»¶ï¼š"
        [ -f "CLAUDE.md" ] && echo "  âœ… CLAUDE.md"
        [ -f ".claude/agents/research-agent.md" ] && echo "  âœ… .claude/agents/research-agent.md"
        [ -f ".claude/agents/solution-agent.md" ] && echo "  âœ… .claude/agents/solution-agent.md"
        [ -f ".claude/agents/github-agent.md" ] && echo "  âœ… .claude/agents/github-agent.md"
        [ -f ".claude/settings.local.json" ] && echo "  ğŸ“„ .claude/settings.local.json (æœ¬åœ°é…ç½®)"
    else
        print_warning "Claude Code Workflow æœªå®‰è£…"
    fi
    echo
}

# æ›´æ–° .gitignore
update_gitignore() {
    print_info "æ›´æ–° .gitignore æ–‡ä»¶..."
    
    local gitignore_content="
# Claude Code local settings
settings.local.json
*.local.json
.claude/settings.local.json"
    
    if [ -f ".gitignore" ]; then
        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸å…³è§„åˆ™
        if ! grep -q "settings.local.json" .gitignore; then
            echo "$gitignore_content" >> .gitignore
            print_success ".gitignore å·²æ›´æ–°"
        else
            print_warning ".gitignore ä¸­å·²å­˜åœ¨ Claude Code ç›¸å…³è§„åˆ™"
        fi
    else
        echo "$gitignore_content" > .gitignore
        print_success ".gitignore å·²åˆ›å»º"
    fi
}

# æç¤ºç”¨æˆ·ä¸‹ä¸€æ­¥æ“ä½œ
show_next_steps() {
    echo
    print_success "ğŸ‰ Claude Code Workflow å®‰è£…å®Œæˆï¼"
    echo
    print_info "å®‰è£…çš„æ–‡ä»¶ï¼š"
    echo "  ğŸ“„ CLAUDE.md - å·¥ä½œæµç¨‹é…ç½®"
    echo "  ğŸ¤– .claude/agents/ - ä¸“é—¨ä»£ç†é…ç½®"
    echo "  ğŸ“ .gitignore - å·²æ›´æ–°æ’é™¤è§„åˆ™"
    echo
    print_info "ä¸‹ä¸€æ­¥æ“ä½œï¼š"
    echo "  1. æ£€æŸ¥å¹¶æ ¹æ®é¡¹ç›®éœ€è¦è°ƒæ•´ CLAUDE.md ä¸­çš„é…ç½®"
    echo "  2. åˆ›å»º .claude/settings.local.jsonï¼ˆå¦‚æœéœ€è¦æœ¬åœ°é…ç½®ï¼‰"
    echo "  3. æäº¤æ›´æ”¹ï¼šgit add . && git commit -m \"Add Claude Code workflow\""
    echo
    print_warning "æ³¨æ„ï¼šsettings.local.json æ–‡ä»¶ä¸ä¼šè¢«æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶"
}

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    echo "================================================="
    echo "    Claude Code Workflow ç®¡ç†å™¨ v$VERSION"
    echo "================================================="
    echo
    echo "ç”¨æ³•: $0 <command>"
    echo
    echo "å‘½ä»¤ï¼š"
    echo "  install    å®‰è£… Claude Code Workflow åˆ°å½“å‰é¡¹ç›®"
    echo "  update     æ›´æ–°å·²å®‰è£…çš„ Claude Code Workflow"
    echo "  uninstall  å¸è½½ Claude Code Workflow"
    echo "  status     æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  help       æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo
    echo "ç¤ºä¾‹ï¼š"
    echo "  ccw install     # å®‰è£…åˆ°å½“å‰é¡¹ç›®"
    echo "  ccw update      # æ›´æ–°é…ç½®"
    echo "  ccw uninstall   # å¸è½½é…ç½®"
    echo "  ccw status      # æŸ¥çœ‹çŠ¶æ€"
    echo
    echo "æ³¨æ„ï¼š"
    echo "  - è¯·åœ¨ç›®æ ‡é¡¹ç›®çš„ Git ä»“åº“æ ¹ç›®å½•ä¸‹è¿è¡Œæ­¤è„šæœ¬"
    echo "  - å¸è½½å’Œæ›´æ–°å‰ä¼šè‡ªåŠ¨å¤‡ä»½ç°æœ‰é…ç½®"
    echo "  - æœ¬åœ°é…ç½®æ–‡ä»¶ settings.local.json ä¸ä¼šè¢«æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶"
}

# ä¸»å‡½æ•°
main() {
    # æ£€æŸ¥å‚æ•°
    if [ $# -eq 0 ]; then
        show_help
        exit 1
    fi
    
    local command="$1"
    
    case "$command" in
        "install")
            check_target_directory
            install_config
            ;;
        "update")
            check_target_directory
            update_config
            ;;
        "uninstall")
            check_target_directory
            uninstall_config
            ;;
        "status")
            check_target_directory
            show_status
            ;;
        "help"|"-h"|"--help")
            show_help
            ;;
        *)
            print_error "æœªçŸ¥å‘½ä»¤: $command"
            echo
            show_help
            exit 1
            ;;
    esac
}

# è¿è¡Œä¸»å‡½æ•°
main "$@"